name: Deploy

on:
  pull_request:
    branches: [nothing]

jobs:
  flask:
    name: Flask Test
    runs-on: ubuntu-latest
    steps:
      - 
        name: Check out code
        uses: actions/checkout@v2
      - 
        name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
          architecture: 'x64'
      -
        name: Install
        run: pip install -r requirements.txt
      -
        name: Run Test
        run: python app/manage.py test app
        env:
          DEBUG: "False"
          SECRET_KEY: "test-secret-key"

  react:
    name: React Test
    runs-on: ubuntu-latest
    steps:
      - 
        name: Check out code
        uses: actions/checkout@v2
      - 
        name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'
      -
        name: Yarn Install
        run: yarn
      -
        name: Yarn Build
        run: yarn build
      - 
        name: Yarn Test
        run: yarn test
      -
        name: Yarn Lint
        run: yarn lint
          
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    steps:
      -
        name: Check out code
        uses: actions/checkout@v2
      - 
        name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id     : ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region            : ${{ secrets.AWS_REGION }}
      -
        name: Terraform Check
        run : terraform -chdir=terraform fmt -check
      # -
      #   name: Terraform Init
      #   run : terraform -chdir=terraform init
      # -
      #   name: Terraform Apply
      #   run : terraform -chdir=terraform apply -auto-approve
      #   env :
      #     AWS_ACCESS_KEY_ID     : ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     AWS_SECRET_ACCESS_KEY : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  
  deploy:
    name: Deploy
    needs: [terraform, react, flask]
    runs-on: ubuntu-latest
    steps:
      - 
        name: Check out code
        uses: actions/checkout@v2
      - 
        name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'
      -
        name: Make Environment File
        uses: SpicyPizza/create-envfile@v1
        with:
          envkey_AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          envkey_AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          envkey_AWS_REGION: ${{ secrets.AWS_REGION }}
          envkey_DEBUG: false
          envkey_SECRET_KEY: 'secret'
          file_name: .env 
      -
        name: Yarn Install
        run : yarn
      -
        name: Yarn Build
        run : yarn build    
      -
        name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id     : ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region            : ${{ secrets.AWS_REGION }}
      -
        name: Build, tag, and push image to Amazon ECR
        run : sh terraform/deploy.sh
